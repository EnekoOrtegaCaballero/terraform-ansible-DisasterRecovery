========================================================================
GUÍA DE OPERACIONES: LABORATORIO DISASTER RECOVERY & AUTOMATION
========================================================================

--- FASE 0: PRERREQUISITOS ---
1. Tener credenciales de AWS configuradas (~/.aws/credentials).
2. Tener instalado: Terraform, Ansible, PowerShell (pwsh) y Zip.

--- FASE 1: DESPLIEGUE DE INFRAESTRUCTURA (Terraform) ---
Objetivo: Levantar Red, Servidor EC2 (Windows) y Base de Datos (RDS SQL Server).

3. Entrar en la carpeta de Terraform:
   cd terraform

4. Inicializar plugins (solo la primera vez):
   terraform init

5. Aplicar el plan de infraestructura:
   terraform apply -auto-approve
   
   > NOTA: Genera automáticamente ../ansible/inventory.ini y group_vars.

6. Volver a la raíz:
   cd ..

--- FASE 2: CONFIGURACIÓN INICIAL (Ansible) ---
Objetivo: Instalar IIS, ASP.NET y desplegar la App v1.0 funcional.

7. Verificar conectividad:
   ansible -i ansible/inventory.ini windows -m win_ping

8. Desplegar Aplicación Base (v1.0):
   ansible-playbook -i ansible/inventory.ini ansible/playbooks/deploy_app.yml

--- FASE 3: ORQUESTACIÓN DEL DESASTRE (Auto-Healing) ---
Objetivo: Backup -> Despliegue Fallido -> Detección -> Recuperación Automática.

9. Regenerar Artefacto Malicioso:
   bash scripts/recrearZip.sh

10. Ejecutar Orquestador Maestro:
    pwsh scripts/orchestrator.ps1

    > FLUJO DE EJECUCIÓN AUTOMÁTICA:
    > A. Backups Paralelos (RDS Snapshot + EBS Snapshot).
    > B. Intento de despliegue v2.0 (Falla y devuelve error).
    > C. Análisis de Logs: Detecta corrupción.
    > D. RECUPERACIÓN (Restore-DrInfrastructure):
    >    - Restaura nueva RDS (lab-db-recovered).
    >    - Crea nuevo volumen EBS desde snapshot.
    >    - Detiene instancia, cambia disco corrupto por nuevo, arranca instancia.
    >    - Actualiza inventory.ini con la nueva IP.
    > E. REPARACIÓN (Ansible):
    >    - Monta el disco D:.
    >    - Inyecta la nueva IP de BBDD en web.config.

--- FASE 4: LIMPIEZA (Drift Management) ---
Importante: Tras la recuperación, el estado de Terraform no coincide con la realidad (Drift).

11. Destruir recursos base:
    cd terraform && terraform destroy -auto-approve

12. Limpieza Manual (Recursos Huérfanos):
    Como el Orquestador creó recursos que Terraform no conoce, debes borrar manualmente en AWS:
    - Base de Datos: "lab-db-recovered"
    - Volúmenes EBS: El volumen restaurado (que no esté en uso).
    - Snapshots: Los creados por el orquestador (snap-pre-update-...).
